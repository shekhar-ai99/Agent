//@version=6
indicator(title="Multi-Signal Indicator [v6]", overlay=true)

// === INPUTS ===
// [Inputs remain the same - use input.* functions]
// --- Entry System ---
grpEntry = "Entry System"
entrySystem = input.string("EMA Crossover", title="Entry System Type", options=["EMA Crossover", "BB Breakout", "BB Reversion"], group=grpEntry)
// --- EMAs Signals ---
grpEMA = "EMA Signals"
emaFastLen = input.int(9, title="Fast EMA Length", minval=1, group=grpEMA)
emaMedLen = input.int(14, title="Medium EMA Length", minval=1, group=grpEMA)
emaSlowLen = input.int(21, title="Slow EMA Length", minval=1, group=grpEMA)
emaEnableCrossBuy = input.bool(true, title="Enable EMA Fast/Slow Cross Buy", group=grpEMA)
emaEnableCrossSell = input.bool(true, title="Enable EMA Fast/Slow Cross Sell", group=grpEMA)
emaEnableMedCrossExit = input.bool(true, title="Enable EMA Fast/Med Cross Exit", group=grpEMA)
// --- Bollinger Bands Signals ---
grpBB = "Bollinger Bands Signals"
showBB = input.bool(true, title="Show Bollinger Bands?", group=grpBB)
bbLen = input.int(20, title="BB Length", minval=1, group=grpBB)
bbStdDev = input.float(2.0, title="BB StdDev Multiplier", minval=0.1, group=grpBB)
bbColor = input.color(color.new(color.gray, 50), title="BB Color", group=grpBB)
bbEnableBreakoutBuy = input.bool(false, title="Enable BB Breakout Buy (Close > Upper)", group=grpBB)
bbEnableBreakoutSell = input.bool(false, title="Enable BB Breakout Sell (Close < Lower)", group=grpBB)
bbEnableReversionBuy = input.bool(false, title="Enable BB Reversion Buy (Close crosses back > Lower)", group=grpBB)
bbEnableReversionSell = input.bool(false, title="Enable BB Reversion Sell (Close crosses back < Upper)", group=grpBB)
bbEnableExitMeanRevert = input.bool(false, title="Enable BB Exit: Mean Reversion (Close > Upper / < Lower)?", group=grpBB)
bbEnableExitReturnToMean = input.bool(true, title="Enable BB Exit: Return to Mean (Cross Middle Band)?", group=grpBB)
bbEnableExitOppositeBand = input.bool(false, title="Enable BB Exit: Touch Opposite Band?", group=grpBB)
// --- RSI Signals ---
grpRSI = "RSI Signals"
rsiLen = input.int(14, title="RSI Length", minval=1, group=grpRSI)
rsiBuyLevel = input.float(55.0, title="RSI Buy Threshold (>)", group=grpRSI)
rsiSellLevel = input.float(45.0, title="RSI Sell Threshold (<)", group=grpRSI)
rsiOBLevel = input.float(70.0, title="RSI Overbought Level", group=grpRSI)
rsiOSLevel = input.float(30.0, title="RSI Oversold Level", group=grpRSI)
rsiEnableThresholdBuy = input.bool(false, title="Enable RSI Cross Buy Threshold Signal (>)", group=grpRSI)
rsiEnableThresholdSell = input.bool(false, title="Enable RSI Cross Sell Threshold Signal (<)", group=grpRSI)
rsiEnableOBExit = input.bool(false, title="Enable RSI Exit on Overbought Cross (< OB)", group=grpRSI)
rsiEnableOSExit = input.bool(false, title="Enable RSI Exit on Oversold Cross (> OS)", group=grpRSI)
// --- MACD Signals ---
grpMACD = "MACD Signals"
macdFastLen = input.int(12, title="MACD Fast Length", group=grpMACD)
macdSlowLen = input.int(26, title="MACD Slow Length", group=grpMACD)
macdSignalLen = input.int(9, title="MACD Signal Length", group=grpMACD)
macdEnableSignalCrossBuy = input.bool(false, title="Enable MACD Signal Line Cross Buy", group=grpMACD)
macdEnableSignalCrossSell = input.bool(false, title="Enable MACD Signal Line Cross Sell", group=grpMACD)
macdEnableZeroCrossBuy = input.bool(false, title="Enable MACD Zero Line Cross Buy", group=grpMACD)
macdEnableZeroCrossSell = input.bool(false, title="Enable MACD Zero Line Cross Sell", group=grpMACD)
// --- Volume Signals ---
grpVol = "Volume Signals"
volMALen = input.int(50, title="Volume MA Length", minval=1, group=grpVol)
volEnableBreakoutBuy = input.bool(false, title="Enable High Volume Breakout Buy", group=grpVol)
volEnableBreakoutSell = input.bool(false, title="Enable High Volume Breakout Sell", group=grpVol)
volEnableLowVolExit = input.bool(true, title="Enable Low Volume Pullback Exit", group=grpVol)
// --- ATR Stop Loss ---
grpATR = "ATR Stop Loss"
useAtrStop = input.bool(true, title="Use ATR Stop Loss for Exit?", group=grpATR)
atrLen = input.int(14, title="ATR Length", minval=1, group=grpATR)
atrMult = input.float(2.0, title="ATR Multiplier", minval=0.1, group=grpATR)
// --- Fibonacci Exit ---
grpFib = "Fibonacci Exit Target"
useFibExit = input.bool(false, title="Use Fibonacci Extension Exit Target?", group=grpFib)
fibLookback = input.int(30, title="Fib Swing Lookback Period", minval=5, group=grpFib)
fibExtensionLevel = input.float(1.618, title="Fib Extension Target Multiplier", minval=0.1, group=grpFib)
// --- Trend / Filter Options ---
grpFilter = "General Filters (Apply to Enabled Entries)"
useTrendConfirmation = input.bool(false, title="Require EMA Trend Confirmation (Med/Slow)?", group=grpFilter)
useAdxFilter = input.bool(false, title="Use ADX Filter?", group=grpFilter)
adxLen = input.int(14, title="ADX Length", minval=1, group=grpFilter)
adxThreshold = input.float(20.0, title="ADX Threshold (>)", minval=0, group=grpFilter)


// === CALCULATIONS ===

// --- Indicators ---
emaFast = ta.ema(close, emaFastLen)
emaMed = ta.ema(close, emaMedLen)
emaSlow = ta.ema(close, emaSlowLen)
[bbMiddle, bbUpper, bbLower] = ta.bb(close, bbLen, bbStdDev)
priceRsi = ta.rsi(close, rsiLen)
[macdLine, signalLine, histLine] = ta.macd(close, macdFastLen, macdSlowLen, macdSignalLen)
volMA = ta.sma(volume, volMALen)
atrVal = ta.atr(atrLen)
[diPos, diNeg, adxVal] = ta.dmi(adxLen, adxLen)

// --- Swing High/Low for Fib (Calculated Globally) --- // MOVED HERE
globalRecentLowest = ta.lowest(low, fibLookback)[1]
globalRecentHighest = ta.highest(high, fibLookback)[1]

// --- Calculate ALL Individual Signal Conditions ---
// EMA
cond_emaCrossBuy = ta.crossover(emaFast, emaSlow)
cond_emaCrossSell = ta.crossunder(emaFast, emaSlow)
cond_emaMedCrossExitLong = ta.crossunder(emaFast, emaMed)
cond_emaMedCrossExitShort = ta.crossover(emaFast, emaMed)
// BB
cond_bbBreakoutBuy = ta.crossover(close, bbUpper)
cond_bbBreakoutSell = ta.crossunder(close, bbLower)
cond_bbReversionBuy = ta.crossover(close, bbLower)
cond_bbReversionSell = ta.crossunder(close, bbUpper)
cond_bbExitMeanRevertLong = close > bbUpper
cond_bbExitMeanRevertShort = close < bbLower
cond_bbExitReturnMeanLong = ta.crossunder(close, bbMiddle)
cond_bbExitReturnMeanShort = ta.crossover(close, bbMiddle)
cond_bbExitOppositeLong = low <= bbLower
cond_bbExitOppositeShort = high >= bbUpper
// RSI
cond_rsiCrossBuyLevel = ta.crossover(priceRsi, rsiBuyLevel)
cond_rsiCrossSellLevel = ta.crossunder(priceRsi, rsiSellLevel)
cond_rsiExitOB = ta.crossunder(priceRsi, rsiOBLevel)
cond_rsiExitOS = ta.crossover(priceRsi, rsiOSLevel)
// MACD
cond_macdSignalCrossBuy = ta.crossover(macdLine, signalLine)
cond_macdSignalCrossSell = ta.crossunder(macdLine, signalLine) // Use ta.under instead of crossunder for MACD sell
cond_macdZeroCrossBuy = ta.crossover(macdLine, 0)
cond_macdZeroCrossSell = ta.crossunder(macdLine, 0) // Use ta.under instead of crossunder for MACD sell
// Volume
highVol = volume > volMA * 1.5
isStrongUpCandle = close > open and close > close[1]
isStrongDownCandle = close < open and close < close[1]
cond_volBreakoutBuy = highVol and isStrongUpCandle
cond_volBreakoutSell = highVol and isStrongDownCandle
cond_volLowVolExitLong = close < emaFast and volume < volMA
cond_volLowVolExitShort = close > emaFast and volume < volMA

// --- State Tracking ---
var bool inLong = false
var bool inShort = false
var float stopLossLevel = na
var float fibTargetLevel = na
var float entryPrice = na
var bool wasInLong = false
var bool wasInShort = false
wasInLong := inLong
wasInShort := inShort

// --- Determine Entry ---
anyBuySignal = (emaEnableCrossBuy and cond_emaCrossBuy) or (bbEnableBreakoutBuy and cond_bbBreakoutBuy) or (bbEnableReversionBuy and cond_bbReversionBuy) or (rsiEnableThresholdBuy and cond_rsiCrossBuyLevel) or (macdEnableSignalCrossBuy and cond_macdSignalCrossBuy) or (macdEnableZeroCrossBuy and cond_macdZeroCrossBuy) or (volEnableBreakoutBuy and cond_volBreakoutBuy)
anySellSignal = (emaEnableCrossSell and cond_emaCrossSell) or (bbEnableBreakoutSell and cond_bbBreakoutSell) or (bbEnableReversionSell and cond_bbReversionSell) or (rsiEnableThresholdSell and cond_rsiCrossSellLevel) or (macdEnableSignalCrossSell and cond_macdSignalCrossSell) or (macdEnableZeroCrossSell and cond_macdZeroCrossSell) or (volEnableBreakoutSell and cond_volBreakoutSell)

trendFilterOkBuy = not useTrendConfirmation or emaMed > emaSlow
trendFilterOkSell = not useTrendConfirmation or emaMed < emaSlow
adxFilterOk = not useAdxFilter or adxVal > adxThreshold

filteredBuySignal = anyBuySignal and trendFilterOkBuy and adxFilterOk
filteredSellSignal = anySellSignal and trendFilterOkSell and adxFilterOk

isNewBuy = filteredBuySignal and not wasInLong
isNewSell = filteredSellSignal and not wasInShort

// Determine Buy/Sell Reason Text // CORRECTED v6 Syntax using direct if/else expression
buyReason = if isNewBuy
    emaEnableCrossBuy and cond_emaCrossBuy ? "EMA Buy" :bbEnableBreakoutBuy and cond_bbBreakoutBuy ? "BB B/O Buy" :bbEnableReversionBuy and cond_bbReversionBuy ? "BB Rev Buy" :rsiEnableThresholdBuy and cond_rsiCrossBuyLevel ? "RSI Buy" :macdEnableSignalCrossBuy and cond_macdSignalCrossBuy ? "MACD Buy" :macdEnableZeroCrossBuy and cond_macdZeroCrossBuy ? "MACD 0 Buy" :volEnableBreakoutBuy and cond_volBreakoutBuy ? "Vol Buy" :"Buy"
else
    ""

sellReason = if isNewSell
    emaEnableCrossSell and cond_emaCrossSell ? "EMA Sell" :bbEnableBreakoutSell and cond_bbBreakoutSell ? "BB B/O Sell" :bbEnableReversionSell and cond_bbReversionSell ? "BB Rev Sell" :rsiEnableThresholdSell and cond_rsiCrossSellLevel ? "RSI Sell" :macdEnableSignalCrossSell and cond_macdSignalCrossSell ? "MACD Sell" :macdEnableZeroCrossSell and cond_macdZeroCrossSell ? "MACD 0 Sell" :volEnableBreakoutSell and cond_volBreakoutSell ? "Vol Sell" :"Sell"
else
    ""

// Update State, SL, Target
if (isNewBuy)
    inLong := true
    inShort := false
    entryPrice := close
    stopLossLevel := low - atrVal * atrMult
    // Use globally calculated swing low
    swingRangeFib = entryPrice - globalRecentLowest
    fibTargetLevel := swingRangeFib > 0 and useFibExit ? entryPrice + swingRangeFib * fibExtensionLevel : na

if (isNewSell)
    inShort := true
    inLong := false
    entryPrice := close
    stopLossLevel := high + atrVal * atrMult
    // Use globally calculated swing high
    swingRangeFib = globalRecentHighest - entryPrice
    fibTargetLevel := swingRangeFib > 0 and useFibExit ? entryPrice - swingRangeFib * fibExtensionLevel : na

// Update SL
if (useAtrStop and inLong and not isNewBuy)
    newStopLong = low - atrVal * atrMult
    stopLossLevel := math.max(stopLossLevel, newStopLong)
if (useAtrStop and inShort and not isNewSell)
    newStopShort = high + atrVal * atrMult
    stopLossLevel := math.min(stopLossLevel, newStopShort)

// --- Determine Exit ---
atrStopHitLong = useAtrStop and inLong and close < stopLossLevel
atrStopHitShort = useAtrStop and inShort and close > stopLossLevel
fibHitLong = useFibExit and inLong and not na(fibTargetLevel) and high >= fibTargetLevel
fibHitShort = useFibExit and inShort and not na(fibTargetLevel) and low <= fibTargetLevel
bbMeanRevertExitLongCond = bbEnableExitMeanRevert and inLong and cond_bbExitMeanRevertLong
bbMeanRevertExitShortCond = bbEnableExitMeanRevert and inShort and cond_bbExitMeanRevertShort
bbReturnExitLongCond = bbEnableExitReturnToMean and inLong and cond_bbExitReturnMeanLong
bbReturnExitShortCond = bbEnableExitReturnToMean and inShort and cond_bbExitReturnMeanShort
bbOppositeExitLongCond = bbEnableExitOppositeBand and inLong and cond_bbExitOppositeLong
bbOppositeExitShortCond = bbEnableExitOppositeBand and inShort and cond_bbExitOppositeShort
rsiExitLongCond = rsiEnableOBExit and inLong and cond_rsiExitOB
rsiExitShortCond = rsiEnableOSExit and inShort and cond_rsiExitOS
volExitLongCond = volEnableLowVolExit and inLong and cond_volLowVolExitLong
volExitShortCond = volEnableLowVolExit and inShort and cond_volLowVolExitShort
emaCrossExitLongCond = emaEnableMedCrossExit and inLong and cond_emaMedCrossExitLong
emaCrossExitShortCond = emaEnableMedCrossExit and inShort and cond_emaMedCrossExitShort

anyLongExit = atrStopHitLong or fibHitLong or bbMeanRevertExitLongCond or bbOppositeExitLongCond or bbReturnExitLongCond or rsiExitLongCond or volExitLongCond or emaCrossExitLongCond
anyShortExit = atrStopHitShort or fibHitShort or bbMeanRevertExitShortCond or bbOppositeExitShortCond or bbReturnExitShortCond or rsiExitShortCond or volExitShortCond or emaCrossExitShortCond

exitedLongThisBar = wasInLong and anyLongExit
exitedShortThisBar = wasInShort and anyShortExit

// Determine Exit Reason Text // CORRECTED v6 Syntax using direct if/else expression
longExitReason = if exitedLongThisBar
    atrStopHitLong ? "ATR SL" :fibHitLong ? "Fib Tgt" :bbMeanRevertExitLongCond ? "BB MR" :bbOppositeExitLongCond ? "BB Oppo" :bbReturnExitLongCond ? "BB Mid" :rsiExitLongCond ? "RSI OB" :volExitLongCond ? "Volume" :emaCrossExitLongCond ? "EMA Cross" :"Exit"
else
    ""

shortExitReason = if exitedShortThisBar
    atrStopHitShort ? "ATR SL" :fibHitShort ? "Fib Tgt" :bbMeanRevertExitShortCond ? "BB MR" :bbOppositeExitShortCond ? "BB Oppo" :bbReturnExitShortCond ? "BB Mid" :rsiExitShortCond ? "RSI OS" :volExitShortCond ? "Volume" :emaCrossExitShortCond ? "EMA Cross" :"Exit"
else
    ""

// Specific check for ATR SL alerts
atrStopFiredLong = wasInLong and atrStopHitLong
atrStopFiredShort = wasInShort and atrStopHitShort

// --- Reset State on Exit ---
if (exitedLongThisBar)
    inLong := false
    stopLossLevel := na
    fibTargetLevel := na
    entryPrice := na

if (exitedShortThisBar)
    inShort := false
    stopLossLevel := na
    fibTargetLevel := na
    entryPrice := na

// === PLOTTING ===
// Plot Indicators
plot(emaFast, color=color.new(color.blue, 0), title="Fast EMA")
plot(emaMed, color=color.new(color.orange, 0), title="Medium EMA")
plot(emaSlow, color=color.new(color.red, 0), title="Slow EMA")
bbMidPlot = plot(showBB ? bbMiddle : na, title="BB Middle", color=bbColor, linewidth=1)
bbUpperPlot = plot(showBB ? bbUpper : na, title="BB Upper", color=bbColor, linewidth=1)
bbLowerPlot = plot(showBB ? bbLower : na, title="BB Lower", color=bbColor, linewidth=1)
fill(bbUpperPlot, bbLowerPlot, color=color.new(bbColor, 90), title="BB Fill")
// Plot SL and Target Lines
plot(inLong and useAtrStop ? stopLossLevel : na, title="Long Stop Loss", color=color.new(color.maroon, 0), style=plot.style_linebr, linewidth=1)
plot(inShort and useAtrStop ? stopLossLevel : na, title="Short Stop Loss", color=color.new(color.teal, 0), style=plot.style_linebr, linewidth=1)
plot(inLong and useFibExit ? fibTargetLevel : na, title="Long Fib Target", color=color.new(color.fuchsia, 0), style=plot.style_linebr, linewidth=1)
plot(inShort and useFibExit ? fibTargetLevel : na, title="Short Fib Target", color=color.new(color.fuchsia, 0), style=plot.style_linebr, linewidth=1)

// UNIFIED SIGNAL LABELS using label.new()
if isNewBuy
    label.new(bar_index, low, text=buyReason, yloc=yloc.belowbar, color=color.new(color.green, 0), textcolor=color.new(color.white, 0), style=label.style_label_up, size=size.small)
if isNewSell
    label.new(bar_index, high, text=sellReason, yloc=yloc.abovebar, color=color.new(color.red, 0), textcolor=color.new(color.white, 0), style=label.style_label_down, size=size.small)
if exitedLongThisBar
    label.new(bar_index, high, text=longExitReason, yloc=yloc.abovebar, color=color.new(color.maroon, 0), textcolor=color.new(color.white, 0), style=label.style_label_down, size=size.small)
if exitedShortThisBar
    label.new(bar_index, low, text=shortExitReason, yloc=yloc.belowbar, color=color.new(color.teal, 0), textcolor=color.new(color.white, 0), style=label.style_label_up, size=size.small)

// Background color
bgcolor(inLong ? color.new(color.green, 90) : inShort ? color.new(color.red, 90) : na)

// === ALERTS === (Simplified - Generic Trigger)
alertcondition(isNewBuy, title="New Buy Signal", message="{{exchange}}:{{ticker}} - Potential Buy Signal at {{close}}")
alertcondition(isNewSell, title="New Sell Signal", message="{{exchange}}:{{ticker}} - Potential Sell Signal at {{close}}")
alertcondition(exitedLongThisBar and not atrStopFiredLong, title="Exit Long Signal (Normal)", message="{{exchange}}:{{ticker}} - Exit Long at {{close}}")
alertcondition(exitedShortThisBar and not atrStopFiredShort, title="Exit Short Signal (Normal)", message="{{exchange}}:{{ticker}} - Exit Short at {{close}}")
alertcondition(atrStopFiredLong, title="ATR Stop Hit (Long)", message="{{exchange}}:{{ticker}} - ATR Stop Loss Hit (Long) at {{close}}")
alertcondition(atrStopFiredShort, title="ATR Stop Hit (Short)", message="{{exchange}}:{{ticker}} - ATR Stop Loss Hit (Short) at {{close}}")