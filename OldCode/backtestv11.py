import pandas as pd
from datetime import time, datetime

# 1) Hardcode CSV data for 2025-04-29
data = '''datetime,open,high,low,close,volume
2025-04-29 09:15:00+05:30,24370.7,24442.25,24364.35,24439.25,0
2025-04-29 09:20:00+05:30,24438.5,24455.05,24424.5,24453.7,0
2025-04-29 09:25:00+05:30,24453.6,24457.65,24413.3,24417.1,0
2025-04-29 09:30:00+05:30,24418.25,24452.9,24393.55,24440.2,0
2025-04-29 09:35:00+05:30,24440.85,24442.5,24359.2,24369.45,0
2025-04-29 09:40:00+05:30,24370.1,24387.05,24303.9,24316.6,0
2025-04-29 09:45:00+05:30,24317.85,24364.5,24308.1,24315.55,0
2025-04-29 09:50:00+05:30,24316.75,24340.05,24290.75,24329.1,0
2025-04-29 09:55:00+05:30,24330.15,24395,24326.5,24390.25,0
2025-04-29 10:00:00+05:30,24390,24396.15,24362.2,24378.3,0
2025-04-29 10:05:00+05:30,24379.15,24379.75,24333.8,24344.65,0
2025-04-29 10:10:00+05:30,24345.2,24365.1,24338.55,24351.55,0
2025-04-29 10:15:00+05:30,24351.3,24354.1,24319,24319,0
2025-04-29 10:20:00+05:30,24318.1,24347.1,24317.4,24346.4,0
2025-04-29 10:25:00+05:30,24346.45,24348.15,24311.3,24317.8,0
2025-04-29 10:30:00+05:30,24318.85,24329.7,24305.5,24314.95,0
2025-04-29 10:35:00+05:30,24316.2,24335.25,24314.55,24331.5,0
2025-04-29 10:40:00+05:30,24331.55,24333.9,24312.8,24321.5,0
2025-04-29 10:45:00+05:30,24321.85,24352.35,24317.95,24350.7,0
2025-04-29 10:50:00+05:30,24349.85,24353.7,24328.45,24330.85,0
2025-04-29 10:55:00+05:30,24330.25,24349.95,24330.25,24333.8,0
2025-04-29 11:00:00+05:30,24334.7,24351.9,24332.8,24351.9,0
2025-04-29 11:05:00+05:30,24353.05,24369.85,24351.9,24367.1,0
2025-04-29 11:10:00+05:30,24367.25,24369.7,24350.6,24356.05,0
2025-04-29 11:15:00+05:30,24356.55,24358.5,24338.95,24348.8,0
2025-04-29 11:20:00+05:30,24348.3,24360.35,24347.05,24348.95,0
2025-04-29 11:25:00+05:30,24349.05,24358.75,24347.6,24349.25,0
2025-04-29 11:30:00+05:30,24348.65,24351.6,24334.95,24347.65,0
2025-04-29 11:35:00+05:30,24347.95,24353.6,24341.6,24346.45,0
2025-04-29 11:40:00+05:30,24346.7,24356.8,24342.2,24354.4,0
2025-04-29 11:45:00+05:30,24354.65,24355.8,24335.3,24340.15,0
2025-04-29 11:50:00+05:30,24340.8,24340.85,24321,24322.95,0
2025-04-29 11:55:00+05:30,24323.4,24329.1,24311.95,24313.25,0
2025-04-29 12:00:00+05:30,24313.4,24322.5,24302.45,24322.05,0
2025-04-29 12:05:00+05:30,24322.15,24323.75,24310.65,24315.5,0
2025-04-29 12:10:00+05:30,24315.3,24322.3,24309.2,24316.6,0
2025-04-29 12:15:00+05:30,24316.4,24321.6,24310.65,24313.1,0
2025-04-29 12:20:00+05:30,24315.1,24315.85,24304.1,24313.65,0
2025-04-29 12:25:00+05:30,24312.95,24317.25,24306.6,24309.75,0
2025-04-29 12:30:00+05:30,24309.25,24330.8,24309.15,24329.95,0
2025-04-29 12:35:00+05:30,24328.75,24347.95,24325.4,24341.35,0
2025-04-29 12:40:00+05:30,24340.6,24346.8,24336.4,24341.85,0
2025-04-29 12:45:00+05:30,24338.8,24344.85,24330.6,24339.55,0
2025-04-29 12:50:00+05:30,24339.15,24358.35,24336.45,24357.9,0
2025-04-29 12:55:00+05:30,24357.75,24363.55,24353,24358.95,0
2025-04-29 13:00:00+05:30,24358.25,24369.5,24352.2,24368.4,0
2025-04-29 13:05:00+05:30,24368.05,24368.5,24350.6,24360.1,0
2025-04-29 13:10:00+05:30,24359.4,24363.55,24353.5,24356.85,0
2025-04-29 13:15:00+05:30,24355.45,24359.35,24341.35,24354.1,0
2025-04-29 13:20:00+05:30,24352.2,24363.15,24346.55,24362.9,0
2025-04-29 13:25:00+05:30,24362.1,24376.05,24356,24366.05,0
2025-04-29 13:30:00+05:30,24366.65,24371.7,24361.45,24366.8,0
2025-04-29 13:35:00+05:30,24366.5,24368.8,24357.4,24366.15,0
2025-04-29 13:40:00+05:30,24367.15,24372.7,24351,24353.9,0
2025-04-29 13:45:00+05:30,24352.7,24366.95,24351.75,24363.45,0
2025-04-29 13:50:00+05:30,24364,24368.75,24355.1,24355.65,0
2025-04-29 13:55:00+05:30,24356.65,24363.4,24347.65,24358.25,0
2025-04-29 14:00:00+05:30,24360.15,24368.3,24356.85,24363.55,0
2025-04-29 14:05:00+05:30,24363.8,24375.5,24360.6,24365.2,0
2025-04-29 14:10:00+05:30,24365.35,24374.8,24360.25,24365.95,0
2025-04-29 14:15:00+05:30,24366.9,24368.3,24355.05,24361.65,0
2025-04-29 14:20:00+05:30,24361.9,24367.55,24356.25,24357.15,0
2025-04-29 14:25:00+05:30,24357.75,24359.7,24342.4,24346,0
2025-04-29 14:30:00+05:30,24346.45,24350.5,24339,24343.45,0
2025-04-29 14:35:00+05:30,24343.75,24361.95,24343.75,24348.1,0
2025-04-29 14:40:00+05:30,24348.8,24360.7,24347.2,24356.45,0
2025-04-29 14:45:00+05:30,24356.2,24357.95,24347.85,24352.95,0
2025-04-29 14:50:00+05:30,24353.35,24358,24344.85,24346.85,0
2025-04-29 14:55:00+05:30,24346.8,24355.7,24339.45,24340.2,0
2025-04-29 15:00:00+05:30,24340.55,24347.8,24325.2,24331.4,0
2025-04-29 15:05:00+05:30,24331.55,24336.5,24324.9,24332.7,0
2025-04-29 15:10:00+05:30,24332.6,24335.6,24324.45,24326.45,0
2025-04-29 15:15:00+05:30,24326.2,24341.45,24310.6,24339.65,0
2025-04-29 15:20:00+05:30,24338.85,24348.5,24325.85,24333.1,0
2025-04-29 15:25:00+05:30,24331.55,24340.85,24317.6,24325.45,0'''
# load into DataFrame
from io import StringIO
df = pd.read_csv(StringIO(data), parse_dates=['datetime'])
df.set_index('datetime', inplace=True)


# 2) Manual indicator calculations
# RSI
window = 10
delta = df['close'].diff()
gain = delta.clip(lower=0)
loss = -delta.clip(upper=0)
avg_gain = gain.rolling(window).mean()
avg_loss = loss.rolling(window).mean()
rs = avg_gain / avg_loss
df['RSI_10'] = 100 - (100 / (1 + rs))

# ATR
tr1 = df['high'] - df['low']
tr2 = (df['high'] - df['close'].shift()).abs()
tr3 = (df['low'] - df['close'].shift()).abs()
tr = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)
df['ATR_10'] = tr.rolling(window).mean()

# EMA for lengths [7,14,21,50]
for L in [7,14,21,50]:
    df[f'EMA{L}'] = df['close'].ewm(span=L, adjust=False).mean()

# MACD
ema12 = df['close'].ewm(span=12, adjust=False).mean()
ema26 = df['close'].ewm(span=26, adjust=False).mean()
df['MACD'] = ema12 - ema26
df['MACD_signal'] = df['MACD'].ewm(span=9, adjust=False).mean()

# SuperTrend helper

def supertrend(df, period=10, mult=3):
    atr = df['ATR_10']
    hl2 = (df['high'] + df['low']) / 2
    ub = hl2 + mult * atr
    lb = hl2 - mult * atr
    st = pd.Series(index=df.index, dtype=float)
    dir = pd.Series(index=df.index, dtype=int)
    for i in range(len(df)):
        if i == 0:
            st.iat[i], dir.iat[i] = lb.iat[i], 1
        else:
            if df['close'].iat[i-1] > st.iat[i-1]:
                st.iat[i], dir.iat[i] = lb.iat[i], 1
            else:
                st.iat[i], dir.iat[i] = ub.iat[i], -1
            if dir.iat[i]==1 and st.iat[i]<st.iat[i-1]: st.iat[i]=st.iat[i-1]
            if dir.iat[i]==-1 and st.iat[i]>st.iat[i-1]: st.iat[i]=st.iat[i-1]
    return st, dir

df['SuperTrend'], df['SuperTrend_dir'] = supertrend(df)

# AlphaTrend
alpha = 0.65*df['close'] + 0.25*df['close'].shift(1)
alpha += 0.1*df['RSI_10']*(df['ATR_10']/df['close'].shift(1))
df['AlphaTrend'] = alpha.ffill().fillna(df['close'])

# 3) Backtest logic (unchanged)
def backtest_cs_alpha(df):
    trades = []
    position = None
    log = []
    # ... rest of your backtest_cs_alpha implementation ...
    return pd.DataFrame(trades, columns=['Entry_Time','Side','Entry','Exit_Time','Exit','Profit'])

if __name__=='__main__':
    print("Running CS_Alpha backtest with manual indicators...")
    trades = backtest_cs_alpha(df)
    print(trades.to_string(index=False))
